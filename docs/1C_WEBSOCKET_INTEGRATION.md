# Интеграция 1C с WebSocket для мониторинга статусов устройств

## Обзор

Данная документация описывает процесс интеграции системы 1C с WebSocket endpoint для получения обновлений статусов устройств в реальном времени.

## WebSocket Endpoint

**URL:** `ws://localhost:8000/ws/devices/{subscription_type}`

### Типы подписок

1. **Подписка на все устройства:**
   ```
   ws://localhost:8000/ws/devices/all
   ```
   - Получает обновления статусов всех устройств
   - Рекомендуется для общего мониторинга

2. **Подписка на конкретное устройство:**
   ```
   ws://localhost:8000/ws/devices/{device_id}
   ```
   - Получает обновления только для указанного устройства
   - Рекомендуется для мониторинга конкретного оборудования

## Формат сообщений

### Структура WebSocket сообщения

```json
{
  "mac_address": "unknown",
  "serial_number": "unknown", 
  "status": "success|fail|error|online|offline",
  "time_start": "2025-08-28T14:54:52.029134",
  "time_end": "2025-08-28T14:52:34.615642",
  "updated_at": "2025-08-28T14:54:58.097435",
  "result": "Описание результата тестирования",
  "device_id": "test_device_001"
}
```

### Описание полей

- **mac_address** - MAC адрес устройства (строка)
- **serial_number** - Серийный номер устройства (строка)
- **status** - Текущий статус устройства:
  - `success` - Тест завершен успешно
  - `fail` - Тест завершен с ошибкой
  - `error` - Ошибка устройства
  - `online` - Устройство подключено
  - `offline` - Устройство отключено
- **time_start** - Время начала тестирования (ISO 8601)
- **time_end** - Время окончания тестирования (ISO 8601)
- **updated_at** - Время последнего обновления статуса (ISO 8601)
- **result** - Текстовое описание результата (может быть null)
- **device_id** - Уникальный идентификатор устройства (строка)

## Требования для 1C

### Системные требования

- 1C:Предприятие 8.3.20 или выше
- Поддержка WebSocket (доступна в современных версиях 1C)
- Доступ к сети для подключения к серверу

### Необходимые разрешения

- Разрешение на исходящие сетевые подключения
- Доступ к порту 8000 на сервере приложения

## Пример подключения в 1C

### Базовое подключение

```bsl
// Создание WebSocket соединения
ВебСокет = Новый ВебСокет;
АдресСервера = "ws://localhost:8000/ws/devices/all";

// Обработчики событий
ВебСокет.УстановитьОбработчикСобытия("ПриПолученииСообщения", ЭтотОбъект, "ОбработкаСообщенияВебСокет");
ВебСокет.УстановитьОбработчикСобытия("ПриОткрытииСоединения", ЭтотОбъект, "ПриОткрытииСоединенияВебСокет");
ВебСокет.УстановитьОбработчикСобытия("ПриЗакрытииСоединения", ЭтотОбъект, "ПриЗакрытииСоединенияВебСокет");
ВебСокет.УстановитьОбработчикСобытия("ПриОшибке", ЭтотОбъект, "ПриОшибкеВебСокет");

// Подключение
ВебСокет.Подключиться(АдресСервера);
```

### Обработка сообщений

```bsl
// Обработчик получения сообщения
Процедура ОбработкаСообщенияВебСокет(Сообщение)
    
    Попытка
        // Парсинг JSON сообщения
        ЧтениеJSON = Новый ЧтениеJSON;
        ЧтениеJSON.УстановитьСтроку(Сообщение.Данные);
        ДанныеУстройства = ПрочитатьJSON(ЧтениеJSON);
        
        // Извлечение данных
        ИдентификаторУстройства = ДанныеУстройства.Получить("device_id");
        СтатусУстройства = ДанныеУстройства.Получить("status");
        РезультатТестирования = ДанныеУстройства.Получить("result");
        ВремяОбновления = ДанныеУстройства.Получить("updated_at");
        
        // Обработка статуса
        Если СтатусУстройства = "success" Тогда
            ОбработатьУспешныйТест(ИдентификаторУстройства, РезультатТестирования);
        ИначеЕсли СтатусУстройства = "fail" Тогда
            ОбработатьНеудачныйТест(ИдентификаторУстройства, РезультатТестирования);
        ИначеЕсли СтатусУстройства = "error" Тогда
            ОбработатьОшибкуУстройства(ИдентификаторУстройства, РезультатТестирования);
        ИначеЕсли СтатусУстройства = "online" Тогда
            ОбработатьПодключениеУстройства(ИдентификаторУстройства);
        ИначеЕсли СтатусУстройства = "offline" Тогда
            ОбработатьОтключениеУстройства(ИдентификаторУстройства);
        КонецЕсли;
        
    Исключение
        // Логирование ошибки
        ЗаписьЖурналаРегистрации("WebSocket.ОшибкаПарсинга", 
            УровеньЖурналаРегистрации.Ошибка,
            ,
            ,
            "Ошибка при обработке WebSocket сообщения: " + ОписаниеОшибки());
    КонецПопытки;
    
КонецПроцедуры
```

## Рекомендации по реализации

### 1. Управление соединением

- Реализуйте автоматическое переподключение при разрыве соединения
- Добавьте таймауты для предотвращения зависания
- Ведите лог подключений для диагностики

### 2. Обработка ошибок

- Предусмотрите обработку сетевых ошибок
- Добавьте валидацию входящих JSON данных
- Реализуйте fallback механизмы при недоступности WebSocket

### 3. Производительность

- Используйте асинхронную обработку сообщений
- Ограничьте количество одновременных подключений
- Реализуйте буферизацию для высокочастотных обновлений

### 4. Безопасность

- Валидируйте все входящие данные
- Используйте HTTPS/WSS в продакшене
- Реализуйте аутентификацию при необходимости

## Тестирование интеграции

### Проверка подключения

1. Убедитесь, что сервер WebSocket запущен
2. Проверьте доступность порта 8000
3. Протестируйте подключение с помощью тестового клиента

### Тестовые сценарии

1. **Подключение к 'all'** - получение обновлений всех устройств
2. **Подключение к конкретному устройству** - фильтрация по device_id
3. **Обработка различных статусов** - success, fail, error, online, offline
4. **Переподключение** - восстановление после разрыва соединения

## Поддержка и диагностика

### Логирование

Рекомендуется вести подробные логи:
- Время подключения/отключения
- Полученные сообщения
- Ошибки парсинга или обработки
- Статистика производительности

### Мониторинг

- Отслеживайте состояние WebSocket соединения
- Контролируйте частоту получения сообщений
- Мониторьте использование памяти и CPU

## Контакты

Для получения технической поддержки обращайтесь к команде разработки платформы тестирования.